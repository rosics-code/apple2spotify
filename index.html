<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify - PKCE Auth</title>
<style>
body { font-family:"Segoe UI",sans-serif; max-width:900px; margin:auto; padding:20px; background:#f0f2f5; }
h1 { text-align:center; color:#1DB954; text-shadow:1px 1px #00000022; }
label { display:block; margin:10px 0 5px; font-weight:bold; color:#333; }
input[type=text]{width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;}
button{padding:10px 20px; margin:5px 5px 15px 0; background:#1DB954; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;}
button:hover{background:#17a44c;}
#trackList{max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:5px; background:white; margin-top:10px;}
.track{display:flex; align-items:center; margin-bottom:5px;}
.track label{flex:1; cursor:pointer;}

/* UI Status Indicator Style */
#spotifyStatus{
    margin-top: -10px; 
    margin-bottom: 10px; 
    font-weight: bold; 
    padding: 5px; 
    border-radius: 4px;
    text-align: center;
}
.status-logged-out { background-color: #ffdddd; color: #cc0000; border: 1px solid #cc0000; }
.status-logged-in { background-color: #ddffdd; color: #1DB954; border: 1px solid #1DB954; }

#log{max-height:200px; overflow-y:auto; background:#222; color:#0f0; padding:10px; border-radius:5px; font-family:monospace; margin-top:10px;}
#progressContainer{width:100%; background:#ddd; height:20px; border-radius:10px; margin-top:10px; display:none;}
#progressBar{width:0%; height:100%; background:#1DB954; border-radius:10px; transition:width 0.2s;}
</style>
</head>
<body>
<h1>üéµ Apple Music ‚Üí Spotify Transfer (PKCE) üéµ</h1>

<label>Apple Music Public Playlist URL:</label>
<input type="text" id="appleUrl" placeholder="https://music.apple.com/...">

<label>Spotify Playlist Name:</label>
<input type="text" id="spotifyPlaylistName" placeholder="My Transferred Playlist">

<div id="spotifyStatus" class="status-logged-out">Spotify: Unauthorized</div>

<button id="fetchApple">Fetch Apple Tracks</button>
<button id="transfer" disabled>Transfer Selected Tracks</button>

<div id="trackList"></div>
<div id="progressContainer"><div id="progressBar"></div></div>
<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.2/src/spotify-web-api.min.js"></script>

<script>
window.onload = async () => {
  // ‚ö†Ô∏è ACTION REQUIRED: Replace with your actual Spotify Client ID
  const SPOTIFY_CLIENT_ID = "52dbb7368d80433194dc029bf4f71137"; 
  
  // üî• FIX: HARDCODED REDIRECT URI. This MUST exactly match the URL registered in your Spotify App settings.
  // Assuming your deployed URL is: https://rosics-code.github.io/apple2spotify/index.html
  const REDIRECT_URI = "https://rosics-code.github.io/apple2spotify/index.html";
  
  const SCOPES = "playlist-modify-public playlist-modify-private user-read-private";
  const SPOTIFY_TOKEN_URL = 'https://accounts.spotify.com/api/token'; 

  const spotifyApi = new SpotifyWebApi();
  const logEl = document.getElementById("log");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const fetchAppleBtn = document.getElementById("fetchApple");
  const transferBtn = document.getElementById("transfer");
  const statusEl = document.getElementById("spotifyStatus"); 

  const log = msg => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  let appleTracks = [];
  let spotifyUserId = null;

  // --- PKCE Utility Functions ---

  const generateRandomString = (length) => {
    const possible = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
    const values = window.crypto.getRandomValues(new Uint8Array(length));
    return values.reduce((acc, x) => acc + possible[x % possible.length], "");
  };

  const base64UrlEncode = (input) => {
    return btoa(String.fromCharCode(...new Uint8Array(input)))
      .replace(/=/g, '')
      .replace(/\+/g, '-')
      .replace(/\//g, '_');
  };

  const pkceChallengeFromVerifier = async (v) => {
    const hashed = await window.crypto.subtle.digest('SHA-256', (new TextEncoder()).encode(v));
    return base64UrlEncode(hashed);
  };
  
  // --- Auth Flow Functions ---

  const redirectToSpotifyAuth = async () => {
    const codeVerifier = generateRandomString(128);
    const codeChallenge = await pkceChallengeFromVerifier(codeVerifier);

    localStorage.setItem('spotify_code_verifier', codeVerifier); 

    const authUrl = new URL('https://accounts.spotify.com/authorize?client_id=$');
    
    authUrl.searchParams.append('client_id', SPOTIFY_CLIENT_ID);
    authUrl.searchParams.append('response_type', 'code');
    authUrl.searchParams.append('redirect_uri', REDIRECT_URI);
    authUrl.searchParams.append('scope', SCOPES);
    authUrl.searchParams.append('code_challenge_method', 'S256');
    authUrl.searchParams.append('code_challenge', codeChallenge);
    
    window.location.href = authUrl.toString();
  };

  const exchangeCodeForToken = async (code) => {
    const codeVerifier = localStorage.getItem('spotify_code_verifier');
    
    if (!codeVerifier) {
      log("‚ùå PKCE Error: Code verifier not found. Try logging in again.");
      return null;
    }
    
    const params = new URLSearchParams();
    params.append('client_id', SPOTIFY_CLIENT_ID);
    params.append('grant_type', 'authorization_code');
    params.append('code', code);
    params.append('redirect_uri', REDIRECT_URI);
    params.append('code_verifier', codeVerifier);
    
    try {
      const response = await fetch(SPOTIFY_TOKEN_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: params
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(`Token exchange failed. Error: ${errorData.error_description || errorData.error}`);
      }
      
      const data = await response.json();
      
      localStorage.setItem('spotify_access_token', data.access_token);
      localStorage.setItem('spotify_refresh_token', data.refresh_token);
      localStorage.removeItem('spotify_code_verifier'); 
      
      return data.access_token;
      
    } catch(e) {
      log("‚ùå Failed to exchange code for token: " + e.message);
      return null;
    }
  };
  
  const refreshToken = async () => {
      const refreshTokenValue = localStorage.getItem('spotify_refresh_token');
      if (!refreshTokenValue) return null;

      const params = new URLSearchParams();
      params.append('client_id', SPOTIFY_CLIENT_ID);
      params.append('grant_type', 'refresh_token');
      params.append('refresh_token', refreshTokenValue);

      try {
        const response = await fetch(SPOTIFY_TOKEN_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: params
        });

        if (!response.ok) throw new Error(`Refresh token failed! Status: ${response.status}`);
        
        const data = await response.json();
        
        localStorage.setItem('spotify_access_token', data.access_token);
        if (data.refresh_token) localStorage.setItem('spotify_refresh_token', data.refresh_token);
        
        log("üîÑ Access token refreshed.");
        return data.access_token;

      } catch (e) {
        log("‚ùå Auto-refresh failed. Please log in again.");
        localStorage.removeItem('spotify_access_token');
        localStorage.removeItem('spotify_refresh_token');
        return null;
      }
  };

  const setupAuth = async () => {
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    let token = localStorage.getItem('spotify_access_token');

    // 1. Handle Redirect from Spotify (Exchange Code for Token)
    if (code) {
      log("‚úÖ Spotify redirect detected. Exchanging code for token...");
      token = await exchangeCodeForToken(code);
      
      // Clean up the URL query parameters
      window.history.replaceState(null, '', REDIRECT_URI); 
    } 
    
    // 2. Try to refresh existing token if the current token is missing/expired
    if (!token) {
        token = await refreshToken();
    }
    
    // 3. Final status check
    if (token) {
      spotifyApi.setAccessToken(token);
      try {
        const me = await spotifyApi.getMe();
        spotifyUserId = me.id;
        
        const displayName = me.display_name || spotifyUserId;
        statusEl.textContent = `Spotify: Logged in as ${displayName}`;
        statusEl.className = "status-logged-in";
        transferBtn.disabled = false;

      } catch(e) { 
        log("‚ùå Token failed validation. Please log in again.");
        localStorage.removeItem('spotify_access_token');
        statusEl.textContent = "Spotify: Session Expired. Click 'Fetch' to Log In.";
        statusEl.className = "status-logged-out";
      }
    } else {
        statusEl.textContent = "Spotify: Click 'Fetch' to Log In";
        statusEl.className = "status-logged-out";
    }
  };
  
  await setupAuth();


  // ---- Fetch Apple Tracks / Login Trigger ----
  fetchAppleBtn.onclick = async () => {
    if (!spotifyApi.getAccessToken()) {
        log("üîÑ Redirecting to Spotify login for authorization...");
        redirectToSpotifyAuth(); 
        return; 
    }
    
    // --- Apple Fetch Logic ---
    const appleUrl = document.getElementById("appleUrl").value.trim();
    if (!appleUrl) { log("‚ùå Enter Apple Music URL"); return; }

    log("üîÑ Fetching Apple Music playlist...");
    try {
      const resp = await fetch(appleUrl);
      const text = await resp.text();
      const jsonMatch = text.match(/<script id="shoebox-store" type="fastboot\/shoebox">(.+?)<\/script>/);
      if (!jsonMatch) { 
        log("‚ùå Playlist data not found. Apple Music scraping method failed."); 
        return; 
      }

      const jsonData = JSON.parse(jsonMatch[1]);
      let tempTracks = [];
      
      for (const key in jsonData) {
        const items = jsonData[key].data;
        if (!items || !Array.isArray(items)) continue; 
        
        items.forEach(item => {
            if(item.type === "playlists" || item.type === "albums") {
                const songs = item.relationships?.tracks?.data || [];
                songs.forEach(song => {
                    if (song.type === "songs" && song.attributes) {
                        tempTracks.push({
                            name: song.attributes.name,
                            artist: song.attributes.artistName
                        });
                    }
                });
            }
            if(item.type==="songs" && item.attributes) {
                 tempTracks.push({name:item.attributes.name,artist:item.attributes.artistName});
            }
        });
      }

      // De-dupe the tracks
      appleTracks = Array.from(new Set(tempTracks.map(t => `${t.name}|${t.artist}`))).map(str => {
        const [name, artist] = str.split('|');
        return { name, artist };
      });


      log(`‚úÖ Found ${appleTracks.length} unique tracks`);
      
      const trackListDiv = document.getElementById("trackList");
      trackListDiv.innerHTML = "";
      appleTracks.forEach((t,i)=>{ 
        const div=document.createElement("div"); 
        div.className="track";
        div.innerHTML=`<input type="checkbox" id="track${i}" checked><label for="track${i}">${t.name} ‚Äî ${t.artist}</label>`;
        trackListDiv.appendChild(div);
      });
      transferBtn.disabled=false;
    } catch(e) { log("‚ùå Error fetching Apple Music playlist: "+e.message); }
  };

  // ---- Transfer Tracks to Spotify ----
  transferBtn.onclick = async () => {
    if(!spotifyUserId || !spotifyApi.getAccessToken()){
        log("‚ùå Spotify not logged in. Click the first button to log in."); 
        return;
    }
    
    const selectedTracks = appleTracks.filter((t,i)=>document.getElementById(`track${i}`)?.checked);

    if(!selectedTracks.length){log("‚ùå No tracks selected"); return;}
    const playlistName = document.getElementById("spotifyPlaylistName").value.trim() || "Apple Music Transfer";

    try {
      const newPlaylist = await spotifyApi.createPlaylist(spotifyUserId,{name:playlistName,public:false});
      log("‚úÖ Created Spotify playlist: "+newPlaylist.name);
      
      progressContainer.style.display="block";
      progressBar.style.width="0%";

      const uris=[];
      for(let i=0;i<selectedTracks.length;i++){
        const t=selectedTracks[i];
        const res=await spotifyApi.searchTracks(`track:${t.name} artist:${t.artist}`,{limit:1});
        
        if(res.tracks.items.length) {
            uris.push(res.tracks.items[0].uri);
            log("Matched: "+t.name);
        } else {
             log("Not found: "+t.name);
        }
        
        progressBar.style.width=`${Math.round((i+1)/selectedTracks.length*100)}%`;
      }

      log(`Found ${uris.length} Spotify matches. Adding to playlist...`);

      const BATCH_SIZE = 100;
      for(let i=0;i<uris.length;i+=BATCH_SIZE) {
          const batch = uris.slice(i,i+BATCH_SIZE);
          await spotifyApi.addTracksToPlaylist(newPlaylist.id, batch);
      }
      
      log("üéâ Transfer complete! Check Spotify for your playlist.");
      progressBar.style.width="100%";
    } catch(e){
        log("‚ùå Error during transfer: "+e.message);
        progressContainer.style.display="none";
    }
  };
};
</script>
</body>
</html>
