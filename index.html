<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify (ULTRA-RESCUE üëë)</title>
<style>
  body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f8f9fa; }
  h1 { text-align: center; color: #1DB954; text-shadow: 1px 1px #eee; }
  input[type=text] { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #1DB954; border-radius: 8px; }
  .controls { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; margin-bottom: 20px; }
  button { padding: 12px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold; transition: 0.2s; }
  #spotifyLogin { background-color: #1DB954; color: white; }
  #fetchApple { background-color: #ff2d55; color: white; }
  #transfer { background-color: #000; color: white; }
  button:disabled { background-color: #ccc; cursor: not-allowed; }
  #trackList { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; border-radius: 12px; background-color: #fff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
  .track { display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f1f1f1; }
  #log { white-space: pre-wrap; background-color: #1a1a1a; color: #32ff7e; padding: 15px; border-radius: 8px; margin-top: 20px; font-family: 'Courier New', Courier, monospace; font-size: 13px; }
</style>
</head>
<body>
<h1>Apple ‚Üí Spotify (ULTRA-RESCUE üëë)</h1>

<label>Playlist Name:</label>
<input type="text" id="spotifyPlaylistName" placeholder="YouAreCuteVille Anthems üíñ">

<div class="controls">
    <button id="spotifyLogin">Login Spotify</button>
    <button id="fetchApple">1. Paste JSON</button>
    <button id="transfer" disabled>2. Transfer Tracks</button>
</div>

<div id="trackList"></div>
<pre id="log">Status: Let's get these 591 bops home... ‚ú®</pre>

<script>
const SPOTIFY_CLIENT_ID = "52dbb7368d80433194dc029bf4f71137";
const REDIRECT_URI = "https://rosics-code.github.io/apple2spotify/index.html";

let spotifyToken = localStorage.getItem("spotify_access_token");
let spotifyUserId = null;
let appleTracks = [];

const log = msg => {
    const logEl = document.getElementById("log");
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
};

// üßº NUCLEAR CLEANER: Nukes all the "feat.", "remix", and parenthesis junk
const cleanSongName = (name) => {
    return name
        .split(' (')[0]       // Removes "(feat. ...)"
        .split(' [')[0]       // Removes "[Remastered]"
        .split(' - ')[0]      // Removes " - Bonus Track"
        .replace(/feat\..*/gi, '') 
        .replace(/ft\..*/gi, '')
        .trim();
};

const updateUI = (ok, name) => {
    document.getElementById("spotifyLogin").style.display = ok ? 'none' : 'block';
    if(ok) log(`‚úÖ Welcome back, king! Logged in as: ${name}`);
    document.getElementById("transfer").disabled = !ok;
};

// PKCE AUTH
function base64urlencode(b){return btoa(String.fromCharCode.apply(null,new Uint8Array(b))).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}
async function sha256(b){return await crypto.subtle.digest("SHA-256",new TextEncoder().encode(b))}
async function generatePKCE(){const v=Array.from(crypto.getRandomValues(new Uint8Array(64))).map(c=>('00'+c.toString(16)).slice(-2)).join("");const c=base64urlencode(await sha256(v));return{verifier:v,challenge:c}}

document.getElementById("spotifyLogin").onclick = async () => {
    const {verifier, challenge} = await generatePKCE();
    sessionStorage.setItem("pkce_verifier", verifier);
    const url = `https://accounts.spotify.com/authorize?response_type=code&client_id=${SPOTIFY_CLIENT_ID}&scope=playlist-modify-private playlist-modify-public user-read-private&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&code_challenge_method=S256&code_challenge=${challenge}`;
    window.location.href = url;
};

const parseAppleJson = (raw) => {
    try {
        const data = JSON.parse(raw);
        const tracksFound = [];
        const find = (obj) => {
            if(!obj || typeof obj !== 'object') return;
            if((obj.type === 'songs' || obj.type === 'library-songs') && obj.attributes?.name) {
                tracksFound.push({ name: obj.attributes.name, artist: obj.attributes.artistName || "Unknown" });
            }
            Object.values(obj).forEach(v => find(v));
        };
        find(data);
        appleTracks = [...appleTracks, ...tracksFound].filter((v,i,a)=>a.findIndex(t=>(t.name===v.name && t.artist===v.artist))===i);
        renderTracks();
        log(`üîé Loaded ${appleTracks.length} unique tracks!`);
    } catch(e) { log("‚ùå Paste error. Try again!"); }
};

function renderTracks() {
    document.getElementById("trackList").innerHTML = appleTracks.map((t, i) => `
        <div class="track">
            <input type="checkbox" id="t${i}" checked>
            <label for="t${i}"><strong>${t.name}</strong> ‚Äî ${t.artist}</label>
        </div>
    `).join('');
}

document.getElementById("fetchApple").onclick = () => {
    const raw = prompt("Paste your 591 bops here:");
    if(raw) parseAppleJson(raw);
};

// üöÄ THE SMART TRANSFER ENGINE
document.getElementById("transfer").onclick = async () => {
    const selected = appleTracks.filter((t, i) => document.getElementById(`t${i}`).checked);
    const pName = document.getElementById("spotifyPlaylistName").value || "Apple Transfer";
    
    try {
        log(`\nüöÄ Starting transfer...`);
        const pResp = await fetch(`https://api.spotify.com/v1/users/${spotifyUserId}/playlists`, {
            method: "POST",
            headers: { Authorization: `Bearer ${spotifyToken}`, "Content-Type": "application/json" },
            body: JSON.stringify({ name: pName, public: false })
        });
        const playlist = await pResp.json();

        const uris = [];
        for(const t of selected) {
            let cleanName = cleanSongName(t.name);
            let query = encodeURIComponent(`track:${cleanName} artist:${t.artist}`);
            
            // ATTEMPT 1: Standard Search
            let sResp = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=5`, {
                headers: { Authorization: "Bearer " + spotifyToken }
            });
            let sData = await sResp.json();
            
            // ATTEMPT 2: Fuzzy Search (If first fails, strip artist specific search)
            if(!sData.tracks?.items?.length) {
                query = encodeURIComponent(`${cleanName} ${t.artist}`);
                sResp = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=5`, {
                    headers: { Authorization: "Bearer " + spotifyToken }
                });
                sData = await sResp.json();
            }

            if(sData.tracks?.items?.length) {
                const explicitMatch = sData.tracks.items.find(item => item.explicit === true);
                const finalMatch = explicitMatch || sData.tracks.items[0];
                uris.push(finalMatch.uri);
                log(`${finalMatch.explicit ? 'üî•' : '‚úÖ'} Found: ${t.name}`);
            } else {
                log(`‚ùå GHOSTED: ${t.name} by ${t.artist}`);
            }
        }

        for (let i = 0; i < uris.length; i += 100) {
            await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
                method: "POST",
                headers: { Authorization: `Bearer ${spotifyToken}`, "Content-Type": "application/json" },
                body: JSON.stringify({ uris: uris.slice(i, i + 100) })
            });
        }
        log(`\nüéâ FINISHED! ${uris.length}/${selected.length} songs added to '${pName}'! üíÖ`);
    } catch(e) { log("‚ùå Error: " + e.message); }
};

window.onload = async () => {
    const code = new URLSearchParams(window.location.search).get("code");
    if(code) {
        window.history.replaceState({}, "", REDIRECT_URI);
        const body = new URLSearchParams({
            client_id: SPOTIFY_CLIENT_ID, grant_type: "authorization_code",
            code, redirect_uri: REDIRECT_URI,
            code_verifier: sessionStorage.getItem("pkce_verifier")
        });
        const resp = await fetch("https://accounts.spotify.com/api/token", {
            method: "POST", headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: body.toString()
        });
        const data = await resp.json();
        spotifyToken = data.access_token;
        localStorage.setItem("spotify_access_token", spotifyToken);
    }
    
    if(spotifyToken) {
        const uResp = await fetch("https://api.spotify.com/v1/me", { headers: { Authorization: "Bearer " + spotifyToken } });
        const uData = await uResp.json();
        spotifyUserId = uData.id;
        updateUI(true, uData.display_name);
    }
};
</script>
</body>
</html>
