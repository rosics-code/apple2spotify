<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify</title>
<style>
  body { font-family: "Segoe UI", sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f0f2f5; }
  h1 { text-align: center; color: #1DB954; text-shadow: 1px 1px #00000022; }
  label { display: block; margin: 10px 0 5px; font-weight: bold; color: #333; }
  input[type=text] { width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 5px; border: 1px solid #ccc; }
  button { padding: 10px 20px; margin: 5px 5px 15px 0; background: #1DB954; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
  button:hover { background: #17a44c; }
  #trackList { max-height: 350px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; border-radius: 5px; background: white; margin-top: 10px; }
  .track { display: flex; align-items: center; margin-bottom: 5px; }
  .track label { flex: 1; cursor: pointer; }
  #log { max-height: 200px; overflow-y: auto; background: #222; color: #0f0; padding: 10px; border-radius: 5px; font-family: monospace; margin-top: 10px; }
  #progressContainer { width: 100%; background: #ddd; height: 20px; border-radius: 10px; margin-top: 10px; display: none; }
  #progressBar { width: 0%; height: 100%; background: #1DB954; border-radius: 10px; transition: width 0.2s; }
</style>
</head>
<body>
<h1>üéµ Apple Music ‚Üí Spotify Transfer üéµ</h1>

<label>Apple Music Public Playlist URL:</label>
<input type="text" id="appleUrl" placeholder="https://music.apple.com/...">

<label>Spotify Playlist Name:</label>
<input type="text" id="spotifyPlaylistName" placeholder="My Transferred Playlist">

<label>Spotify Access Token:</label>
<input type="text" id="spotifyTokenInput" placeholder="Paste token here">

<button id="setToken">Set Spotify Token</button>
<button id="fetchApple">Fetch Apple Tracks</button>
<button id="transfer" disabled>Transfer Selected Tracks</button>

<div id="trackList"></div>

<div id="progressContainer">
  <div id="progressBar"></div>
</div>

<pre id="log"></pre>

<!-- Correct Spotify Web API JS library -->
<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.2/src/spotify-web-api.min.js"></script>

<script>
window.onload = () => {
  const spotifyApi = new SpotifyWebApi();
  const logEl = document.getElementById("log");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");

  const log = msg => {
    logEl.textContent += msg + "\n";
    logEl.scrollTop = logEl.scrollHeight;
  };

  let appleTracks = [];
  let spotifyUserId = null;

  // Set Spotify token manually
  document.getElementById("setToken").onclick = async () => {
    const token = document.getElementById("spotifyTokenInput").value.trim();
    if (!token) { log("‚ùå Enter a Spotify token"); return; }
    spotifyApi.setAccessToken(token);
    try {
      const me = await spotifyApi.getMe();
      spotifyUserId = me.id;
      log("‚úÖ Spotify logged in as: " + spotifyUserId);
    } catch (e) {
      log("‚ùå Failed to get Spotify user: " + e.message);
    }
  };

  // Fetch Apple Music tracks
  document.getElementById("fetchApple").onclick = async () => {
    const appleUrl = document.getElementById("appleUrl").value.trim();
    if (!appleUrl) { log("‚ùå Enter Apple Music URL"); return; }

    log("üîÑ Fetching Apple Music playlist...");
    try {
      const resp = await fetch(appleUrl);
      const text = await resp.text();
      const jsonMatch = text.match(/<script id="shoebox-store" type="fastboot\/shoebox">(.+?)<\/script>/);
      if (!jsonMatch) { log("‚ùå Playlist JSON not found"); return; }

      const jsonData = JSON.parse(jsonMatch[1]);
      appleTracks = [];
      for (const key in jsonData) {
        const items = jsonData[key].data;
        if (!items) continue;
        items.forEach(item => {
          if (item.type === "songs") appleTracks.push({ name: item.attributes.name, artist: item.attributes.artistName });
        });
      }

      log(`‚úÖ Found ${appleTracks.length} tracks`);

      // display tracks with checkboxes
      const trackListDiv = document.getElementById("trackList");
      trackListDiv.innerHTML = "";
      appleTracks.forEach((t, i) => {
        const div = document.createElement("div");
        div.className = "track";
        div.innerHTML = `<input type="checkbox" id="track${i}" checked><label for="track${i}">${t.name} ‚Äî ${t.artist}</label>`;
        trackListDiv.appendChild(div);
      });

      document.getElementById("transfer").disabled = false;
    } catch(e) {
      log("‚ùå Error fetching Apple Music playlist: " + e.message);
    }
  };

  // Transfer selected tracks to Spotify
  document.getElementById("transfer").onclick = async () => {
    if (!spotifyUserId) { log("‚ùå Set Spotify token first"); return; }
    const selectedTracks = appleTracks.filter((t, i) => document.getElementById(`track${i}`).checked);
    if (!selectedTracks.length) { log("‚ùå No tracks selected"); return; }

    const playlistName = document.getElementById("spotifyPlaylistName").value.trim() || "Apple Music Transfer";

    try {
      // create playlist
      const newPlaylist = await spotifyApi.createPlaylist(spotifyUserId, { name: playlistName, public: false });
      log("‚úÖ Created Spotify playlist: " + newPlaylist.name);

      progressContainer.style.display = "block";
      progressBar.style.width = "0%";

      // search & add tracks
      const uris = [];
      for (let i = 0; i < selectedTracks.length; i++) {
        const t = selectedTracks[i];
        const res = await spotifyApi.searchTracks(`${t.name} ${t.artist}`, { limit: 1 });
        if (res.tracks.items.length) {
          uris.push(res.tracks.items[0].uri);
          log("Matched: " + t.name);
        } else {
          log("Not found: " + t.name);
        }
        progressBar.style.width = `${Math.round((i+1)/selectedTracks.length*100)}%`;
      }

      // add tracks in chunks of 100
      for (let i = 0; i < uris.length; i += 100) {
        const chunk = uris.slice(i, i + 100);
        await spotifyApi.addTracksToPlaylist(newPlaylist.id, chunk);
      }

      log("üéâ Transfer complete!");
      progressBar.style.width = "100%";
    } catch (e) {
      log("‚ùå Error: " + e.message);
    }
  };
};
</script>
</body>
</html>
