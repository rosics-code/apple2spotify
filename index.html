<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify (HYPER-SPEED âš¡)</title>
<style>
  body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f8f9fa; }
  h1 { text-align: center; color: #1DB954; }
  input[type=text] { width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #1DB954; border-radius: 8px; }
  .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
  button { padding: 12px 20px; border: none; border-radius: 25px; cursor: pointer; font-size: 14px; font-weight: bold; }
  #spotifyLogin { background-color: #1DB954; color: white; }
  #fetchApple { background-color: #ff2d55; color: white; }
  #transfer { background-color: #000; color: white; }
  #trackList { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; background: #fff; margin-bottom: 20px; }
  #log { white-space: pre-wrap; background-color: #1a1a1a; color: #32ff7e; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; height: 400px; overflow-y: auto; }
</style>
</head>
<body>
<h1>Apple â†’ Spotify (HYPER-SPEED âš¡)</h1>
<input type="text" id="spotifyPlaylistName" placeholder="Corrected Anthems ðŸ’–">
<div class="controls">
    <button id="spotifyLogin">Login Spotify</button>
    <button id="fetchApple">1. Paste JSON</button>
    <button id="transfer" disabled>2. Transfer Fast ðŸš€</button>
</div>
<div id="trackList"></div>
<pre id="log">Ready to fix the vibe, johnball589... âœ¨</pre>

<script>
const SPOTIFY_CLIENT_ID = "52dbb7368d80433194dc029bf4f71137";
const REDIRECT_URI = "https://rosics-code.github.io/apple2spotify/index.html";
let spotifyToken = localStorage.getItem("spotify_access_token"), spotifyUserId = null, appleTracks = [];

const log = msg => { const l = document.getElementById("log"); l.textContent += msg + "\n"; l.scrollTop = l.scrollHeight; };

const clean = (n) => n.split(' (')[0].split(' [')[0].split(' - ')[0].replace(/feat\..*/gi,'').replace(/ft\..*/gi,'').trim();

const updateUI = (ok, name) => {
    document.getElementById("spotifyLogin").style.display = ok ? 'none' : 'block';
    if(ok) log(`âœ… Authenticated: ${name}`);
    document.getElementById("transfer").disabled = !ok;
};

document.getElementById("spotifyLogin").onclick = () => {
    const url = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&scope=playlist-modify-private playlist-modify-public&redirect_uri=${encodeURIComponent(REDIRECT_URI)}`;
    window.location.href = url;
};

document.getElementById("fetchApple").onclick = () => {
    const raw = prompt("Paste the JSON:");
    if(!raw) return;
    const data = JSON.parse(raw);
    const found = [];
    const search = (obj) => {
        if(!obj || typeof obj !== 'object') return;
        if((obj.type === 'songs' || obj.type === 'library-songs') && obj.attributes?.name) {
            found.push({ name: obj.attributes.name, artist: obj.attributes.artistName });
        }
        Object.values(obj).forEach(v => search(v));
    };
    search(data);
    appleTracks = found;
    document.getElementById("trackList").innerHTML = appleTracks.map(t => `<div>${t.name} - ${t.artist}</div>`).join('');
    log(`ðŸ”Ž Loaded ${appleTracks.length} tracks.`);
};

document.getElementById("transfer").onclick = async () => {
    const pName = document.getElementById("spotifyPlaylistName").value || "Fixed Playlist";
    log(`ðŸš€ TURBO START...ING`);
    
    const pResp = await fetch(`https://api.spotify.com/v1/users/${spotifyUserId}/playlists`, {
        method: "POST", headers: { Authorization: `Bearer ${spotifyToken}` },
        body: JSON.stringify({ name: pName, public: false })
    });
    const playlist = await pResp.json();

    // Process searches in Parallel for HYPER-SPEED
    const trackPromises = appleTracks.map(async (t) => {
        const cleanName = clean(t.name);
        const query = encodeURIComponent(`track:${cleanName} artist:${t.artist}`);
        const sResp = await fetch(`https://api.spotify.com/v1/search?q=${query}&type=track&limit=10`, {
            headers: { Authorization: `Bearer ${spotifyToken}` }
        });
        const sData = await sResp.json();
        
        if (sData.tracks?.items?.length) {
            // FILTER: Only keep items where the artist name actually matches
            const realMatches = sData.tracks.items.filter(item => 
                item.artists.some(a => a.name.toLowerCase().includes(t.artist.toLowerCase()) || t.artist.toLowerCase().includes(a.name.toLowerCase()))
            );
            
            const bestSet = realMatches.length ? realMatches : sData.tracks.items;
            const explicit = bestSet.find(i => i.explicit) || bestSet[0];
            log(`${explicit.explicit ? 'ðŸ”¥' : 'âœ…'} ${t.name} â€” ${t.artist}`);
            return explicit.uri;
        }
        log(`âŒ MISSING: ${t.name}`);
        return null;
    });

    const uris = (await Promise.all(trackPromises)).filter(u => u !== null);

    for (let i = 0; i < uris.length; i += 100) {
        await fetch(`https://api.spotify.com/v1/playlists/${playlist.id}/tracks`, {
            method: "POST", headers: { Authorization: `Bearer ${spotifyToken}` },
            body: JSON.stringify({ uris: uris.slice(i, i + 100) })
        });
    }
    log(`\nðŸŽ‰ FINISHED! ${uris.length} tracks in '${pName}'!`);
};

window.onload = async () => {
    const hash = window.location.hash.substring(1).split('&').reduce((a, b) => { const [k, v] = b.split('='); a[k] = v; return a; }, {});
    if (hash.access_token) {
        spotifyToken = hash.access_token;
        localStorage.setItem("spotify_access_token", spotifyToken);
        window.location.hash = "";
    }
    if (spotifyToken) {
        const uResp = await fetch("https://api.spotify.com/v1/me", { headers: { Authorization: `Bearer ${spotifyToken}` } });
        const uData = await uResp.json();
        spotifyUserId = uData.id;
        updateUI(true, uData.display_name);
    }
};
</script>
</body>
</html>
