<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify</title>
<style>
  body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
  h1 { text-align: center; }
  input[type=text] { width: 100%; padding: 8px; margin: 5px 0; }
  button { padding: 10px 15px; margin: 5px 0; }
  #trackList { max-height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin-top: 10px; }
  .track { display: flex; align-items: center; margin-bottom: 5px; }
  .track label { flex: 1; cursor: pointer; }
</style>
</head>
<body>
<h1>Apple Music â†’ Spotify Transfer</h1>

<label>
  Apple Music Public Playlist URL:
  <input type="text" id="appleUrl" placeholder="https://music.apple.com/...">
</label>

<label>
  Spotify Playlist Name:
  <input type="text" id="spotifyPlaylistName" placeholder="My Transferred Playlist">
</label>

<label>
  Spotify Access Token:
  <input type="text" id="spotifyTokenInput" placeholder="Paste token here">
</label>

<button id="setToken">Set Spotify Token</button>
<button id="fetchApple">Fetch Apple Tracks</button>
<button id="transfer" disabled>Transfer Selected Tracks</button>

<div id="trackList"></div>
<pre id="log"></pre>

<!-- Spotify Web API JS -->
<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.2/dist/spotify-web-api.min.js"></script>
<script>
const spotifyApi = new SpotifyWebApi();
const log = msg => document.getElementById("log").textContent += msg + "\n";

let appleTracks = [];
let spotifyUserId = null;

// Set Spotify token manually
document.getElementById("setToken").onclick = async () => {
  const token = document.getElementById("spotifyTokenInput").value.trim();
  if (!token) { log("Enter a Spotify token"); return; }
  spotifyApi.setAccessToken(token);
  try {
    const me = await spotifyApi.getMe();
    spotifyUserId = me.id;
    log("Spotify logged in as: " + spotifyUserId);
  } catch (e) {
    log("Failed to get Spotify user: " + e.message);
  }
};

// Fetch Apple Music tracks
document.getElementById("fetchApple").onclick = async () => {
  const appleUrl = document.getElementById("appleUrl").value.trim();
  if (!appleUrl) { log("Enter Apple Music URL"); return; }

  log("Fetching Apple Music playlist...");
  const resp = await fetch(appleUrl);
  const text = await resp.text();
  const jsonMatch = text.match(/<script id="shoebox-store" type="fastboot\/shoebox">(.+?)<\/script>/);
  if (!jsonMatch) { log("Playlist JSON not found"); return; }

  const jsonData = JSON.parse(jsonMatch[1]);
  appleTracks = [];
  for (const key in jsonData) {
    const items = jsonData[key].data;
    if (!items) continue;
    items.forEach(item => {
      if (item.type === "songs") appleTracks.push({ name: item.attributes.name, artist: item.attributes.artistName });
    });
  }
  log(`Found ${appleTracks.length} tracks`);

  // display tracks with checkboxes
  const trackListDiv = document.getElementById("trackList");
  trackListDiv.innerHTML = "";
  appleTracks.forEach((t, i) => {
    const div = document.createElement("div");
    div.className = "track";
    div.innerHTML = `<input type="checkbox" id="track${i}" checked><label for="track${i}">${t.name} â€” ${t.artist}</label>`;
    trackListDiv.appendChild(div);
  });

  document.getElementById("transfer").disabled = false;
};

// Transfer selected tracks to Spotify
document.getElementById("transfer").onclick = async () => {
  if (!spotifyUserId) { log("Set Spotify token first"); return; }
  const selectedTracks = appleTracks.filter((t, i) => document.getElementById(`track${i}`).checked);
  if (!selectedTracks.length) { log("No tracks selected"); return; }

  const playlistName = document.getElementById("spotifyPlaylistName").value.trim() || "Apple Music Transfer";

  try {
    // create playlist
    const newPlaylist = await spotifyApi.createPlaylist(spotifyUserId, { name: playlistName, public: false });
    log("Created Spotify playlist: " + newPlaylist.name);

    // search & add tracks
    const uris = [];
    for (const t of selectedTracks) {
      const res = await spotifyApi.searchTracks(`${t.name} ${t.artist}`, { limit: 1 });
      if (res.tracks.items.length) {
        uris.push(res.tracks.items[0].uri);
        log("Matched: " + t.name);
      } else {
        log("Not found: " + t.name);
      }
    }

    // add tracks in chunks of 100
    for (let i = 0; i < uris.length; i += 100) {
      const chunk = uris.slice(i, i + 100);
      await spotifyApi.addTracksToPlaylist(newPlaylist.id, chunk);
    }

    log("ðŸŽ‰ Transfer complete!");
  } catch (e) {
    log("Error: " + e.message);
  }
};
</script>
</body>
</html>
