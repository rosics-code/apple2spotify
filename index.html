<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify</title>
<style>
body { font-family:"Segoe UI",sans-serif; max-width:900px; margin:auto; padding:20px; background:#f0f2f5; }
h1 { text-align:center; color:#1DB954; text-shadow:1px 1px #00000022; }
label { display:block; margin:10px 0 5px; font-weight:bold; color:#333; }
input[type=text]{width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;}
button{padding:10px 20px; margin:5px 5px 15px 0; background:#1DB954; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;}
button:hover{background:#17a44c;}
#trackList{max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:5px; background:white; margin-top:10px;}
.track{display:flex; align-items:center; margin-bottom:5px;}
.track label{flex:1; cursor:pointer;}
/* UI Status Indicator Style */
#spotifyStatus{
    margin-top: -10px; 
    margin-bottom: 10px; 
    font-weight: bold; 
    padding: 5px; 
    border-radius: 4px;
    text-align: center;
}
.status-logged-out { background-color: #ffdddd; color: #cc0000; border: 1px solid #cc0000; }
.status-logged-in { background-color: #ddffdd; color: #1DB954; border: 1px solid #1DB954; }

#log{max-height:200px; overflow-y:auto; background:#222; color:#0f0; padding:10px; border-radius:5px; font-family:monospace; margin-top:10px;}
#progressContainer{width:100%; background:#ddd; height:20px; border-radius:10px; margin-top:10px; display:none;}
#progressBar{width:0%; height:100%; background:#1DB954; border-radius:10px; transition:width 0.2s;}
</style>
</head>
<body>
<h1>üéµ Apple Music ‚Üí Spotify Transfer üéµ</h1>

<label>Apple Music Public Playlist URL:</label>
<input type="text" id="appleUrl" placeholder="https://music.apple.com/...">

<label>Spotify Playlist Name:</label>
<input type="text" id="spotifyPlaylistName" placeholder="My Transferred Playlist">

<div id="spotifyStatus" class="status-logged-out">Spotify: Unauthorized</div>

<button id="fetchApple">Fetch Apple Tracks</button>
<button id="transfer" disabled>Transfer Selected Tracks</button>

<div id="trackList"></div>
<div id="progressContainer"><div id="progressBar"></div></div>
<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.2/src/spotify-web-api.min.js"></script>

<script>
window.onload = async () => {
  // ‚ö†Ô∏è CHANGE THIS: Replace with your actual Spotify Client ID 
  const SPOTIFY_CLIENT_ID = "52dbb7368d80433194dc029bf4f71137"; 
  const REDIRECT_URI = window.location.href.split('#')[0]; 
  const SCOPES = "playlist-modify-public playlist-modify-private user-read-private";

  const spotifyApi = new SpotifyWebApi();
  const logEl = document.getElementById("log");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const fetchAppleBtn = document.getElementById("fetchApple");
  const transferBtn = document.getElementById("transfer");
  const statusEl = document.getElementById("spotifyStatus"); // New Status Element

  const log = msg => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  let appleTracks = [];
  let spotifyUserId = null;

  // ---- Implicit Grant Flow Helper ----
  function getHashParams() {
    const hash = window.location.hash.substring(1);
    const params = {};
    hash.split("&").forEach(kv => { const [key,val] = kv.split("="); params[key] = decodeURIComponent(val.replace(/\+/g, ' ')); });
    return params;
  }
  
  // ---- Spotify Auth Functions ----
  function redirectToSpotifyAuth() {
    // üî• FIX: Corrected the Spotify authorization URL and Client ID insertion
    const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
    window.location = authUrl;
  }

  async function handleAuthToken() {
    const params = getHashParams();
    if (params.access_token) {
      spotifyApi.setAccessToken(params.access_token);
      // Clean up the URL hash after grabbing the token
      window.history.pushState("", document.title, window.location.pathname + window.location.search);
      
      try {
        const me = await spotifyApi.getMe();
        spotifyUserId = me.id;
        
        // ‚ú® UI Update for success
        const displayName = me.display_name || spotifyUserId;
        log(`‚úÖ Spotify logged in as: ${displayName}`);
        statusEl.textContent = `Spotify: Logged in as ${displayName}`;
        statusEl.className = "status-logged-in";
        transferBtn.disabled = false;

      } catch(e) { 
        log("‚ùå Failed to get Spotify user. Token may be expired."); 
        spotifyApi.setAccessToken(null); // Clear the bad token
        
        // ‚ú® UI Update for failure
        statusEl.textContent = "Spotify: Authorization Failed/Expired";
        statusEl.className = "status-logged-out";
      }
    } else {
        // ‚ú® UI Update for default state
        log("‚ö†Ô∏è Not logged into Spotify. Click 'Fetch Apple Tracks' to authorize/login first.");
        statusEl.textContent = "Spotify: Click 'Fetch' to Log In";
        statusEl.className = "status-logged-out";
    }
  }

  // Check for an existing token on load (but DO NOT redirect)
  await handleAuthToken();

  // ---- Fetch Apple Tracks / Login Trigger ----
  fetchAppleBtn.onclick = async () => {
    // If not logged in, trigger the login redirect instead of fetching
    if (!spotifyApi.getAccessToken()) {
        log("üîÑ Redirecting to Spotify login...");
        redirectToSpotifyAuth(); 
        return; 
    }
    
    // --- START of Apple Fetch Logic (runs only if logged in) ---
    const appleUrl = document.getElementById("appleUrl").value.trim();
    if (!appleUrl) { log("‚ùå Enter Apple Music URL"); return; }

    log("üîÑ Fetching Apple Music playlist...");
    try {
      const resp = await fetch(appleUrl);
      const text = await resp.text();
      const jsonMatch = text.match(/<script id="shoebox-store" type="fastboot\/shoebox">(.+?)<\/script>/);
      if (!jsonMatch) { log("‚ùå Playlist JSON not found (Apple Music page structure changed?)"); return; }

      const jsonData = JSON.parse(jsonMatch[1]);
      let tempTracks = [];
      
      // Scrape Logic (kept the previous logic that looks for songs in relationships/directly)
      for (const key in jsonData) {
        const items = jsonData[key].data;
        if (!items || !Array.isArray(items)) continue; 
        
        items.forEach(item => {
            if(item.type === "playlists" || item.type === "albums") {
                const songs = item.relationships?.tracks?.data || [];
                songs.forEach(song => {
                    if (song.type === "songs" && song.attributes) {
                        tempTracks.push({
                            name: song.attributes.name,
                            artist: song.attributes.artistName
                        });
                    }
                });
            }
            // Fallback for tracks listed directly
            if(item.type==="songs" && item.attributes) {
                 tempTracks.push({name:item.attributes.name,artist:item.attributes.artistName});
            }
        });
      }

      // De-dupe the tracks
      appleTracks = Array.from(new Set(tempTracks.map(t => `${t.name}|${t.artist}`))).map(str => {
        const [name, artist] = str.split('|');
        return { name, artist };
      });


      log(`‚úÖ Found ${appleTracks.length} unique tracks`);
      
      const trackListDiv = document.getElementById("trackList");
      trackListDiv.innerHTML = "";
      appleTracks.forEach((t,i)=>{ 
        const div=document.createElement("div"); 
        div.className="track";
        div.innerHTML=`<input type="checkbox" id="track${i}" checked><label for="track${i}">${t.name} ‚Äî ${t.artist}</label>`;
        trackListDiv.appendChild(div);
      });
      transferBtn.disabled=false;
    } catch(e) { log("‚ùå Error fetching Apple Music playlist: "+e.message); }
    // --- END of Apple Fetch Logic ---
  };

  // ---- Transfer Tracks to Spotify ----
  transferBtn.onclick = async () => {
    if(!spotifyUserId || !spotifyApi.getAccessToken()){
        log("‚ùå Spotify not logged in. Click the first button to log in."); 
        return;
    }
    
    // Collect only the selected tracks based on checkbox state
    const selectedTracks = appleTracks.filter((t,i)=>document.getElementById(`track${i}`)?.checked);

    if(!selectedTracks.length){log("‚ùå No tracks selected"); return;}
    const playlistName = document.getElementById("spotifyPlaylistName").value.trim() || "Apple Music Transfer";

    try {
      // 1. Create the new playlist
      const newPlaylist = await spotifyApi.createPlaylist(spotifyUserId,{name:playlistName,public:false});
      log("‚úÖ Created Spotify playlist: "+newPlaylist.name);
      
      progressContainer.style.display="block";
      progressBar.style.width="0%";

      // 2. Search Spotify for URIs
      const uris=[];
      for(let i=0;i<selectedTracks.length;i++){
        const t=selectedTracks[i];
        // Search using track name and artist for best match
        const res=await spotifyApi.searchTracks(`track:${t.name} artist:${t.artist}`,{limit:1});
        
        if(res.tracks.items.length) {
            uris.push(res.tracks.items[0].uri);
            log("Matched: "+t.name);
        } else {
             log("Not found: "+t.name);
        }
        
        progressBar.style.width=`${Math.round((i+1)/selectedTracks.length*100)}%`;
      }

      log(`Found ${uris.length} Spotify matches. Adding to playlist...`);

      // 3. Add tracks in batches (100 max per request)
      const BATCH_SIZE = 100;
      for(let i=0;i<uris.length;i+=BATCH_SIZE) {
          const batch = uris.slice(i,i+BATCH_SIZE);
          await spotifyApi.addTracksToPlaylist(newPlaylist.id, batch);
      }
      
      log("üéâ Transfer complete! Check Spotify for your playlist.");
      progressBar.style.width="100%";
    } catch(e){
        log("‚ùå Error during transfer: "+e.message);
        progressContainer.style.display="none"; // Hide progress on fail
    }
  };
};
</script>
</body>
</html>
