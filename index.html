<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Apple2Spotify</title>
<style>
body { font-family:"Segoe UI",sans-serif; max-width:900px; margin:auto; padding:20px; background:#f0f2f5; }
h1 { text-align:center; color:#1DB954; text-shadow:1px 1px #00000022; }
label { display:block; margin:10px 0 5px; font-weight:bold; color:#333; }
input[type=text]{width:100%; padding:10px; margin-bottom:10px; border-radius:5px; border:1px solid #ccc;}
button{padding:10px 20px; margin:5px 5px 15px 0; background:#1DB954; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold;}
button:hover{background:#17a44c;}
#trackList{max-height:350px; overflow-y:auto; border:1px solid #ccc; padding:10px; border-radius:5px; background:white; margin-top:10px;}
.track{display:flex; align-items:center; margin-bottom:5px;}
.track label{flex:1; cursor:pointer;}
#log{max-height:200px; overflow-y:auto; background:#222; color:#0f0; padding:10px; border-radius:5px; font-family:monospace; margin-top:10px;}
#progressContainer{width:100%; background:#ddd; height:20px; border-radius:10px; margin-top:10px; display:none;}
#progressBar{width:0%; height:100%; background:#1DB954; border-radius:10px; transition:width 0.2s;}
</style>
</head>
<body>
<h1>üéµ Apple Music ‚Üí Spotify Transfer üéµ</h1>

<label>Apple Music Public Playlist URL:</label>
<input type="text" id="appleUrl" placeholder="https://music.apple.com/...">

<label>Spotify Playlist Name:</label>
<input type="text" id="spotifyPlaylistName" placeholder="My Transferred Playlist">

<button id="fetchApple">Fetch Apple Tracks</button>
<button id="transfer" disabled>Transfer Selected Tracks</button>

<div id="trackList"></div>
<div id="progressContainer"><div id="progressBar"></div></div>
<pre id="log"></pre>

<script src="https://cdn.jsdelivr.net/npm/spotify-web-api-js@1.5.2/src/spotify-web-api.min.js"></script>

<script>
window.onload = async () => {
  const SPOTIFY_CLIENT_ID = "79fe3f4e650b4e65b800afeb15dc19e3"; // replace with your app client_id
  const REDIRECT_URI = window.location.href.split('#')[0]; // auto-detect current page (works with /index.html or /)
  const SCOPES = "playlist-modify-public playlist-modify-private user-read-private";

  const spotifyApi = new SpotifyWebApi();
  const logEl = document.getElementById("log");
  const progressContainer = document.getElementById("progressContainer");
  const progressBar = document.getElementById("progressBar");
  const fetchAppleBtn = document.getElementById("fetchApple");
  const transferBtn = document.getElementById("transfer");

  const log = msg => { logEl.textContent += msg + "\n"; logEl.scrollTop = logEl.scrollHeight; };
  let appleTracks = [];
  let spotifyUserId = null;

  // ---- Implicit Grant Flow ----
  function getHashParams() {
    const hash = window.location.hash.substring(1);
    const params = {};
    hash.split("&").forEach(kv => { const [key,val] = kv.split("="); params[key] = decodeURIComponent(val); });
    return params;
  }

  async function handleAuth() {
    const params = getHashParams();
    if (params.access_token) {
      spotifyApi.setAccessToken(params.access_token);
      try {
        const me = await spotifyApi.getMe();
        spotifyUserId = me.id;
        log("‚úÖ Spotify logged in as: " + spotifyUserId);
      } catch(e) { log("‚ùå Failed to get Spotify user: " + e.message); }
    } else {
      const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
      window.location = authUrl;
    }
  }

  await handleAuth();

  // ---- Fetch Apple Tracks ----
  fetchAppleBtn.onclick = async () => {
    const appleUrl = document.getElementById("appleUrl").value.trim();
    if (!appleUrl) { log("‚ùå Enter Apple Music URL"); return; }

    log("üîÑ Fetching Apple Music playlist...");
    try {
      const resp = await fetch(appleUrl);
      const text = await resp.text();
      const jsonMatch = text.match(/<script id="shoebox-store" type="fastboot\/shoebox">(.+?)<\/script>/);
      if (!jsonMatch) { log("‚ùå Playlist JSON not found"); return; }

      const jsonData = JSON.parse(jsonMatch[1]);
      appleTracks = [];
      for (const key in jsonData) {
        const items = jsonData[key].data;
        if (!items) continue;
        items.forEach(item => { if(item.type==="songs") appleTracks.push({name:item.attributes.name,artist:item.attributes.artistName}); });
      }

      log(`‚úÖ Found ${appleTracks.length} tracks`);
      const trackListDiv = document.getElementById("trackList");
      trackListDiv.innerHTML = "";
      appleTracks.forEach((t,i)=>{ 
        const div=document.createElement("div"); 
        div.className="track";
        div.innerHTML=`<input type="checkbox" id="track${i}" checked><label for="track${i}">${t.name} ‚Äî ${t.artist}</label>`;
        trackListDiv.appendChild(div);
      });
      transferBtn.disabled=false;
    } catch(e) { log("‚ùå Error fetching Apple Music playlist: "+e.message); }
  };

  // ---- Transfer Tracks to Spotify ----
  transferBtn.onclick = async () => {
    if(!spotifyUserId){log("‚ùå Spotify not logged in"); return;}
    const selectedTracks = appleTracks.filter((t,i)=>document.getElementById(`track${i}`).checked);
    if(!selectedTracks.length){log("‚ùå No tracks selected"); return;}
    const playlistName = document.getElementById("spotifyPlaylistName").value.trim() || "Apple Music Transfer";

    try {
      const newPlaylist = await spotifyApi.createPlaylist(spotifyUserId,{name:playlistName,public:false});
      log("‚úÖ Created Spotify playlist: "+newPlaylist.name);
      progressContainer.style.display="block";
      progressBar.style.width="0%";

      const uris=[];
      for(let i=0;i<selectedTracks.length;i++){
        const t=selectedTracks[i];
        const res=await spotifyApi.searchTracks(`${t.name} ${t.artist}`,{limit:1});
        if(res.tracks.items.length) uris.push(res.tracks.items[0].uri);
        log(res.tracks.items.length?"Matched: "+t.name:"Not found: "+t.name);
        progressBar.style.width=`${Math.round((i+1)/selectedTracks.length*100)}%`;
      }

      for(let i=0;i<uris.length;i+=100) await spotifyApi.addTracksToPlaylist(newPlaylist.id,uris.slice(i,i+100));
      log("üéâ Transfer complete!");
      progressBar.style.width="100%";
    } catch(e){log("‚ùå Error: "+e.message);}
  };
};
</script>
</body>
</html>
